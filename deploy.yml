---
- name: Instalação do Docker
  hosts: ec2

  gather_facts: true
  any_errors_fatal: true
  become: yes

  vars:
    ansible_ssh_private_key_file: "~/.ssh/key"
      
  tasks:
    - name: Adicionar chave de host ao known_hosts
      command: ssh-keyscan -H "{{ ansible_host }}" >> ~/.ssh/known_hosts

    - name: Instalar Docker
      shell: "curl -fsSL https://get.docker.com | sh"
      become: yes
      become_user: ubuntu

    - name: Instalar AWS CLI
      become: yes
      become_user: root
      apt:
        name: awscli
        state: present

    

    - name: Pull da imagem do ECR
      environment:
        AWS_ACCESS_KEY_ID: "{{ lookup('env', 'AWS_ACCESS_KEY') }}"
        AWS_SECRET_ACCESS_KEY: "{{ lookup('env', 'AWS_SECRET_KEY') }}"
        AWS_REGION: "us-east-1"
      script:
        cmd: |
          aws ecr get-login --no-include-email --region us-east-1 | sh -
          docker pull 455968579615.dkr.ecr.us-east-1.amazonaws.com/authsure:latest
